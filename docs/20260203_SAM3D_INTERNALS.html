<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAM3D Internals - Pipeline, Parameters & VRAM Optimization</title>
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-red: #f85149;
            --border-color: #30363d;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            padding: 2rem;
        }
        
        .container { max-width: 1100px; margin: 0 auto; }
        
        h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--accent-blue);
        }
        
        .subtitle {
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .tag {
            display: inline-block;
            background: var(--accent-purple);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-bottom: 1.5rem;
        }
        
        .section {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        h2 {
            font-size: 1.3rem;
            margin-bottom: 1rem;
            color: var(--accent-green);
        }
        
        h3 {
            font-size: 1.1rem;
            margin: 1.5rem 0 0.75rem 0;
            color: var(--accent-purple);
        }
        
        h4 {
            font-size: 1rem;
            margin: 1rem 0 0.5rem 0;
            color: var(--accent-orange);
        }
        
        p { margin-bottom: 0.75rem; }
        
        code {
            background: var(--bg-tertiary);
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            color: var(--accent-orange);
        }
        
        pre {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.85rem;
            margin: 1rem 0;
        }
        
        pre code { background: none; padding: 0; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 0.75rem;
            text-align: left;
        }
        
        th {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
        }
        
        tr:hover { background: var(--bg-tertiary); }
        
        .info-box {
            background: rgba(56, 139, 253, 0.1);
            border-left: 4px solid var(--accent-blue);
            padding: 1rem;
            border-radius: 0 6px 6px 0;
            margin: 1rem 0;
        }
        
        .warning-box {
            background: rgba(210, 153, 34, 0.1);
            border-left: 4px solid var(--accent-orange);
            padding: 1rem;
            border-radius: 0 6px 6px 0;
            margin: 1rem 0;
        }
        
        .danger-box {
            background: rgba(248, 81, 73, 0.1);
            border-left: 4px solid var(--accent-red);
            padding: 1rem;
            border-radius: 0 6px 6px 0;
            margin: 1rem 0;
        }
        
        .success-box {
            background: rgba(63, 185, 80, 0.1);
            border-left: 4px solid var(--accent-green);
            padding: 1rem;
            border-radius: 0 6px 6px 0;
            margin: 1rem 0;
        }
        
        /* Pipeline Diagram */
        .pipeline-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin: 1.5rem 0;
        }
        
        .stage-box {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .stage-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0.5rem;
        }
        
        .stage-number {
            background: var(--accent-blue);
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        
        .stage-title {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .stage-model {
            color: var(--accent-purple);
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .stage-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 0.75rem;
            font-size: 0.85rem;
        }
        
        .stage-detail-item {
            background: var(--bg-secondary);
            padding: 0.5rem;
            border-radius: 4px;
        }
        
        .stage-detail-label {
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        
        .stage-arrow {
            text-align: center;
            color: var(--text-secondary);
            font-size: 1.2rem;
        }
        
        /* File tree */
        .file-tree {
            background: var(--bg-tertiary);
            padding: 1rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        .file-tree .folder { color: var(--accent-blue); }
        .file-tree .file { color: var(--text-secondary); }
        .file-tree .highlight { color: var(--accent-green); font-weight: bold; }
        .file-tree .comment { color: var(--accent-orange); }
        
        ul { padding-left: 1.5rem; margin: 0.5rem 0; }
        li { margin: 0.3rem 0; }
        
        .timestamp {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¯ SAM3D Internals</h1>
        <p class="subtitle">Pipeline Architecture, Tunable Parameters & VRAM Optimization</p>
        <span class="tag">SAM3D / TRELLIS</span>
        
        <!-- Overview -->
        <div class="section">
            <h2>ğŸ“‹ Overview</h2>
            <p>SAM3D is a single-image to 3D reconstruction tool built on Microsoft's <strong>TRELLIS</strong> architecture. It takes an RGB image + mask and outputs a 3D mesh (GLB/PLY) with vertex colors.</p>
            
            <div class="info-box">
                <strong>Key Insight:</strong> SAM3D uses monocular depth estimation (MoGe) to get partial 3D from the image, then a generative model "hallucinates" the unseen parts (back, sides) based on training data.
            </div>
            
            <h3>How Single-Image â†’ 3D Works</h3>
            <pre><code>Single Image â†’ MoGe Depth Model â†’ 2.5D Pointmap (front view only)
                                        â†“
                              TRELLIS Generative Model
                                        â†“
                              Full 3D Voxel Grid (including back/sides)</code></pre>
            <p>The back and sides are <em>generated</em>, not observed. Running the same image multiple times may produce slightly different results.</p>
        </div>
        
        <!-- Pipeline Stages -->
        <div class="section">
            <h2>âš™ï¸ Pipeline Stages</h2>
            
            <div class="pipeline-vertical">
                <!-- Stage 0 -->
                <div class="stage-box">
                    <div class="stage-header">
                        <div class="stage-number">0</div>
                        <span class="stage-title">Preprocessing</span>
                        <span class="stage-model">MoGe + DINOv2</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                        Depth estimation â†’ Pointmap generation â†’ Image/mask resize to 518Ã—518 â†’ Feature extraction
                    </p>
                    <div class="stage-details">
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">Input</div>
                            <div>RGB Image + Mask</div>
                        </div>
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">Output</div>
                            <div>Condition embeddings</div>
                        </div>
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">VRAM</div>
                            <div>~2-3 GB</div>
                        </div>
                    </div>
                </div>
                
                <div class="stage-arrow">â†“</div>
                
                <!-- Stage 1 -->
                <div class="stage-box">
                    <div class="stage-header">
                        <div class="stage-number">1</div>
                        <span class="stage-title">Sparse Structure Sampling</span>
                        <span class="stage-model">ss_generator</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                        Determines which voxels in a 16Â³ grid are occupied (where the object exists in 3D space).
                    </p>
                    <div class="stage-details">
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">Resolution</div>
                            <div>16Â³ = 4,096 voxels</div>
                        </div>
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">Output</div>
                            <div>N occupied voxels</div>
                        </div>
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">VRAM</div>
                            <div>+2-4 GB</div>
                        </div>
                    </div>
                </div>
                
                <div class="stage-arrow">â†“</div>
                
                <!-- Stage 2 -->
                <div class="stage-box">
                    <div class="stage-header">
                        <div class="stage-number">2</div>
                        <span class="stage-title">Sparse Latent Sampling</span>
                        <span class="stage-model">slat_generator</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                        For each occupied voxel, generates an 8-dimensional latent vector encoding appearance/geometry.
                    </p>
                    <div class="stage-details">
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">Latent Dim</div>
                            <div>8 channels</div>
                        </div>
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">Output</div>
                            <div>N Ã— 8 feature matrix</div>
                        </div>
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">VRAM</div>
                            <div>+2-3 GB</div>
                        </div>
                    </div>
                </div>
                
                <div class="stage-arrow">â†“</div>
                
                <!-- Stage 3 -->
                <div class="stage-box" style="border-color: var(--accent-orange);">
                    <div class="stage-header">
                        <div class="stage-number" style="background: var(--accent-orange);">3</div>
                        <span class="stage-title">Decode (Dual Decoder)</span>
                        <span class="stage-model">slat_decoder_gs + slat_decoder_mesh</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                        Two parallel decoders: one generates Gaussian Splatting (colors), one generates Mesh (geometry). Results are merged.
                    </p>
                    <div class="stage-details">
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">GS Decoder</div>
                            <div>N Ã— num_gaussians points</div>
                        </div>
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">Mesh Decoder</div>
                            <div>Vertices + Faces</div>
                        </div>
                        <div class="stage-detail-item">
                            <div class="stage-detail-label">VRAM</div>
                            <div>+4-6 GB (PEAK)</div>
                        </div>
                    </div>
                </div>
                
                <div class="stage-arrow">â†“</div>
                
                <!-- Output -->
                <div class="stage-box" style="border-color: var(--accent-green);">
                    <div class="stage-header">
                        <div class="stage-number" style="background: var(--accent-green);">âœ“</div>
                        <span class="stage-title">Export</span>
                    </div>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                        Mesh geometry + GS vertex colors â†’ GLB file with vertex colors
                    </p>
                </div>
            </div>
            
            <div class="warning-box">
                <strong>âš ï¸ OOM typically occurs in Stage 3 (Decode)</strong><br>
                This is the peak VRAM stage. A 3200Ã—2082 image on RTX 5080 (16GB) peaked at ~14.9GB.
            </div>
        </div>
        
        <!-- Tunable Parameters -->
        <div class="section">
            <h2>ğŸ›ï¸ Tunable Parameters</h2>
            
            <table>
                <tr>
                    <th>Parameter</th>
                    <th>Location</th>
                    <th>Default</th>
                    <th>Tunable?</th>
                    <th>Effect</th>
                </tr>
                <tr>
                    <td><code>num_gaussians</code></td>
                    <td>slat_decoder_gs.yaml</td>
                    <td>32</td>
                    <td style="color: var(--accent-red);">âŒ No*</td>
                    <td>Gaussians per voxel (weights tied)</td>
                </tr>
                <tr>
                    <td><code>resolution</code> (ss)</td>
                    <td>ss_generator.yaml</td>
                    <td>16</td>
                    <td style="color: var(--accent-red);">âŒ No*</td>
                    <td>Voxel grid resolution</td>
                </tr>
                <tr>
                    <td><code>resolution</code> (decoder)</td>
                    <td>slat_decoder_gs.yaml</td>
                    <td>64</td>
                    <td style="color: var(--accent-red);">âŒ No*</td>
                    <td>Output resolution</td>
                </tr>
                <tr>
                    <td><code>input image size</code></td>
                    <td>runtime</td>
                    <td>any</td>
                    <td style="color: var(--accent-green);">âœ… Yes</td>
                    <td>Condition quality</td>
                </tr>
                <tr>
                    <td><code>dtype</code></td>
                    <td>pipeline.yaml</td>
                    <td>float16</td>
                    <td style="color: var(--accent-orange);">âš ï¸ Careful</td>
                    <td>Precision (float16/float32)</td>
                </tr>
            </table>
            
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem;">
                * Resolution parameters are tied to learned position embeddings. Changing them requires retraining.
            </p>
            
            <h3>Understanding num_gaussians</h3>
            <p>This is the most important tunable parameter for VRAM optimization:</p>
            
            <pre><code>Total Gaussian points = Occupied_Voxels Ã— num_gaussians

Example (bottle test):
- Occupied voxels: ~580
- num_gaussians: 32 (default)
- Total points: 580 Ã— 32 = 18,560 Gaussians

With num_gaussians: 8
- Total points: 580 Ã— 8 = 4,640 Gaussians (75% reduction)</code></pre>
            
            <div class="info-box">
                <strong>Quality vs VRAM tradeoff:</strong><br>
                Lower <code>num_gaussians</code> = fewer points = less detail per region, but same overall shape (voxel structure unchanged).
            </div>
        </div>
        
        <!-- VRAM Optimization -->
        <div class="section">
            <h2>ğŸ’¾ VRAM Optimization</h2>
            
            <div class="danger-box">
                <strong>âš ï¸ Important Discovery (2026-02-03):</strong><br>
                <code>num_gaussians</code> CANNOT be changed at runtime! The checkpoint weights are trained for <code>num_gaussians=32</code> specifically. Changing the config causes shape mismatch errors:
                <pre style="margin: 0.5rem 0; font-size: 0.8rem;">size mismatch for offset_perturbation: checkpoint [32, 3] vs model [8, 3]</pre>
            </div>
            
            <h3>What Actually Works</h3>
            <table>
                <tr>
                    <th>Method</th>
                    <th>Works?</th>
                    <th>Notes</th>
                </tr>
                <tr>
                    <td>Reduce input image size</td>
                    <td style="color: var(--accent-green);">âœ… Yes</td>
                    <td>Smaller image = less VRAM in all stages</td>
                </tr>
                <tr>
                    <td>Post-processing downsample</td>
                    <td style="color: var(--accent-green);">âœ… Yes</td>
                    <td>Generate full, then reduce points</td>
                </tr>
                <tr>
                    <td style="text-decoration: line-through;">Change num_gaussians</td>
                    <td style="color: var(--accent-red);">âŒ No</td>
                    <td>Weights tied to 32</td>
                </tr>
                <tr>
                    <td style="text-decoration: line-through;">Change resolution</td>
                    <td style="color: var(--accent-red);">âŒ No</td>
                    <td>Weights tied to 16Â³/64Â³</td>
                </tr>
            </table>
            
            <h3>Post-processing Downsample (Recommended)</h3>
            <p>If you need to reduce point count after generation:</p>
            <pre><code># Voxel downsample
python tools/downsample_pointcloud.py output.glb --voxel 0.02 -o output_down.ply

# Uniform downsample (keep every 2nd point)
python tools/downsample_pointcloud.py output.glb --uniform 2 -o output_down.ply

# Random downsample (keep 50%)
python tools/downsample_pointcloud.py output.glb --random 0.5 -o output_down.ply</code></pre>
        </div>
        
        <!-- File Structure -->
        <div class="section">
            <h2>ğŸ“ File Structure</h2>
            
            <div class="file-tree">
<span class="folder">GenesisVIGA/</span>
â”œâ”€â”€ <span class="folder">tools/</span>
â”‚   â””â”€â”€ <span class="folder">sam3d/</span>
â”‚       â””â”€â”€ <span class="file">sam3d_worker.py</span>          <span class="comment"># Entry point (called by VIGA)</span>
â”‚
â””â”€â”€ <span class="folder">utils/third_party/sam3d/</span>
    â”œâ”€â”€ <span class="folder">sam3d_objects/</span>
    â”‚   â”œâ”€â”€ <span class="folder">pipeline/</span>
    â”‚   â”‚   â””â”€â”€ <span class="file">inference_pipeline.py</span> <span class="comment"># Main inference logic</span>
    â”‚   â””â”€â”€ <span class="folder">models/</span>
    â”‚       â”œâ”€â”€ <span class="folder">sparse_structure/</span>     <span class="comment"># Stage 1 model</span>
    â”‚       â”œâ”€â”€ <span class="folder">structured_latent/</span>    <span class="comment"># Stage 2 model</span>
    â”‚       â””â”€â”€ <span class="folder">slat_decoder_*/</span>       <span class="comment"># Stage 3 decoders</span>
    â”‚
    â””â”€â”€ <span class="folder">checkpoints/hf/checkpoints/</span>
        â”œâ”€â”€ <span class="highlight">pipeline.yaml</span>             <span class="comment"># Main config (only usable one)</span>
        â”œâ”€â”€ <span class="file">ss_generator.yaml</span>         <span class="comment"># Stage 1 config</span>
        â”œâ”€â”€ <span class="file">slat_generator.yaml</span>       <span class="comment"># Stage 2 config</span>
        â”œâ”€â”€ <span class="file">slat_decoder_gs.yaml</span>      <span class="comment"># GS decoder (num_gaussians=32, fixed)</span>
        â””â”€â”€ <span class="file">slat_decoder_mesh.yaml</span>    <span class="comment"># Mesh decoder</span>
            </div>
            
            <div class="success-box">
                <strong>Key Point:</strong> All SAM3D configs are in <code>utils/third_party/sam3d/</code>. VIGA just calls <code>sam3d_worker.py</code> with a config path.
            </div>
        </div>
        
        <!-- Relationship to VIGA -->
        <div class="section">
            <h2>ğŸ”— Relationship to VIGA</h2>
            
            <pre><code>VIGA Workflow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Video â†’ Frames â†’ SAM2 Segmentation â†’ Masks                     â”‚
â”‚                                          â†“                      â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                              â”‚       SAM3D           â”‚          â”‚
â”‚                              â”‚  (This document)      â”‚          â”‚
â”‚                              â”‚                       â”‚          â”‚
â”‚                              â”‚  Image + Mask â†’ GLB   â”‚          â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                          â†“                      â”‚
â”‚                              Scene Composition â†’ Final Output   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</code></pre>
            
            <p>SAM3D is a <strong>self-contained module</strong> within VIGA. All the parameters and configs discussed in this document are SAM3D-specific, not VIGA-specific.</p>
        </div>
        
        <!-- Quick Reference -->
        <div class="section">
            <h2>ğŸ“Œ Quick Reference</h2>
            
            <h4>To reduce VRAM usage:</h4>
            <ol>
                <li><strong>Reduce input image size</strong> (target &lt;2M pixels for 16GB VRAM)</li>
                <li>Post-process with downsampling tool after generation</li>
            </ol>
            
            <h4>To improve quality:</h4>
            <ol>
                <li>Use higher resolution input images (if VRAM allows)</li>
                <li>Ensure clean masks (no noise)</li>
                <li>Use Windows native instead of WSL (better VRAM efficiency)</li>
            </ol>
            
            <h4>Cannot change without retraining:</h4>
            <ul>
                <li><code>num_gaussians</code> (fixed at 32, weights tied)</li>
                <li>Voxel grid resolution (16Â³ for sparse structure)</li>
                <li>Decoder resolution (64Â³)</li>
                <li>Latent dimensions (8 channels)</li>
            </ul>
        </div>
        
        <p class="timestamp">
            ğŸ“… Created: 2026-02-03 15:47 PST<br>
            ğŸ¤– Author: Yuna<br>
            ğŸ“‚ Category: SAM3D / TRELLIS (separate from VIGA workflow docs)
        </p>
    </div>
</body>
</html>
<!-- Created by Yuna -->